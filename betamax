#!/bin/bash
# betamax - Terminal session recorder for TUI apps
# Inspired by charmbracelet/vhs, using tmux for headless operation

set -e

# Resolve script directory for sourcing modules
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source modules
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/args.sh"
source "$SCRIPT_DIR/lib/keys.sh"
source "$SCRIPT_DIR/lib/validate.sh"
source "$SCRIPT_DIR/lib/capture.sh"
source "$SCRIPT_DIR/lib/session.sh"
source "$SCRIPT_DIR/lib/runner.sh"

main() {
  # Parse command line arguments
  parse_args "$@"

  # Load keys from file if specified (with line tracking for validation)
  load_keys_file_with_lines

  # Validate keys file before processing
  validate_keys_file

  # Exit early if only validating
  if [[ "$VALIDATE_ONLY" == true ]]; then
    echo "Validation passed"
    exit 0
  fi

  # Expand @repeat loops
  expand_loops

  # Process @set and @require directives
  process_directives

  # Compute runtime values
  compute_delay_sec
  compute_terminal_size

  # Start tmux session
  session_start

  # Wait for initial pattern if specified
  session_wait_for_pattern

  # Send keys
  run_keys

  # Capture final state if requested
  if [[ "$CAPTURE" == true ]]; then
    capture_final
  fi

  # Cleanup
  session_cleanup
}

main "$@"
